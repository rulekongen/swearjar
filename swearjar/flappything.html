{%head%}
<title>Flappy thing</title>
{%menu%}
<style>
#container {
  width: 1000px;
  height: 800px;
  position: relative;
  background: skyblue;
}

#sky {
  width: 1000px;
  height: 200px;
  top: -200px;
  position:absolute;
}

#leftborder {
  height:800px;
  width:10px;
  position: absolute;
  left: -10px;
}

#animate {
  width: 40px;
  height: 53px;
  position: absolute;
  /* background-image: url("https://i.postimg.cc/WpqSWQWp/flappything.png"); */
  background-image: url("https://i.postimg.cc/qqc1mKJV/arthursmil.png");
  left: 350px;
  top:350px;
  /* border:1px solid black; */
}

#ground {
  left: 0px;
  width: 1000px;
  height: 25px;
  position: absolute;
  top: 775px;
  background-color: gray;
}

.pipe {
  width: 100px;
  left: 900px;
  position: absolute;
  background-color: green;
}

.gate {
  top: 0px;
  width: 1px;
  height:800px;
  left: 1000px;
  position: absolute;
  /* border:1px solid black; */
}

#menu {
  width:200px;
  height: 300px;
  top: 200px;
  left:400px;
  position: absolute;
  /* border:1px solid black; */
  z-index: 99999999;
}

.score {
  top: 50px;
  left: 490px;
  position: absolute;
  z-index: 99999999;
  color: white;
}


</style>
<body>

<div class="container" id ="container" unselectable="on" onselectstart="return false;">
  <div id="sky"></div>
  <div id="leftborder"></div>
  <div id="score" class="score h1">0</div>
  <div id="menu">
    <button class="btn btn-success col-12" onclick="myMove()">Start</button>
    <button class="btn btn-secondary col-12 mt-2" onclick="showScore()">Highscore</button>

    <div class="dead text-center pt-3">
      <span class="h3" style="color:white;">You crashed!</span>
      <button id="dead-score" class="btn btn-primary col-12" onclick="saveScore()">Save score</button>
    </div>
  </div>
  <div id="animate"></div>
  <div id="ground"></div>
</div>

<div id="stats">
  <h5>Stats</h5>
  <div>Flapppower <span id="flapppower"></span></div>
  <div>Velocity <span id="velocity"></span></div>
  <div>Position <span id="position"></span></div>
  <div>Angle <span id="angle"></span></div>
</div>

<div id="score-modal" style="z-index:999999999;" class="modal fade pt-5" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Highscore</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul data-source="score">
          <li data-repeat><strong data-field="Username"></strong> <span data-field="Score"></span></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

gAuthenticated = false;
isAuthenticated(function(isAuthenticated) {
  gAuthenticated = isAuthenticated;
});

$('.dead').hide();

function showScore() {
  dsScore.getData();
  $('#score-modal').modal('show');
}

var dsScore;

setUsername();
function setUsername() {
  if (!sessionStorage.firstname || sessionStorage.firstname === "undefined" || sessionStorage.firstname === "null") {
    sessionStorage.firstname = prompt("What is your name?");
  }
  if(sessionStorage.firstname && sessionStorage.firstname !== "undefined" && sessionStorage.firstname !== "null") {
    $('#username').text(sessionStorage.firstname);
  } else {
    $('#username').text("No name, no predicting");
  }
}

$(document).ready(function() {
  dsScore = new dataSource({
    name: "score",
    dataFields: ["User_ID", "Username", "Score"],
    editFields: ["User_ID", "Username", "Score"],
    view: "atbv_FlappyThing_Highscore",
    targetTable: "atbl_FlappyThing_Highscore",
    anonymous: !gAuthenticated,
    orderBy: "Score DESC"
  });
});

function saveScore() {
  if(!sessionStorage.firstname || sessionStorage.firstname === "undefined" || sessionStorage.firstname === "null") {
    alert("Could not determine name, please log in or set name to add your score");
    return;
  }

  dsScore.addNew();
  dsScore.selectedRow("Username", sessionStorage.firstname);
  dsScore.selectedRow("User_ID", sessionStorage.user_id ? sessionStorage.user_id : null);
  dsScore.selectedRow("Score", score);
  dsScore.save(function() {
    dsScore.getData();
  });

  $('.dead').hide();
}

$('#animate').hide();
$('#stats').hide();

function showStats() {
  showStats = true;
  $('#stats').show()
}

var elem = document.getElementById("animate");
var ground = document.getElementById("ground");

var pos = 350;
var score = 0;
var scoreint = 0;
var pipeint = 0;
var velocity = 0.5;
var flapppower = 30;
var angle = 90;
var showStats = false;

function myMove() {
  $('#menu').hide();
  $('.dead').hide();
  $('#animate').show();

  $('.pipe').each(function(index, element) {
    let tContainer = document.getElementById("container");
    tContainer.removeChild(element);
  });

  $('.gate').each(function(index, element) {
    let tContainer = document.getElementById("container");
    tContainer.removeChild(element);
  });

  var id = setInterval(frame, 5);
  pos = 350;
  pipeint = 0;
  score = 0;
  $('.score').text(score);

  function frame() {

    if (pos == 750) {
      pos = 0
    }
    else {
      if (flapppower > 40) {
        flapppower -= 0.17;
      }
      if (angle > -100) {
        angle += 0.3;
      }
      velocity += 0.020;//0.010;
      pos += velocity;
      scoreint++;
      pipeint++;

      if(showStats) {
        $('#flapppower').text(flapppower);
        $('#velocity').text(velocity);
        $('#position').text(pos);
        $('#angle').text(angle);
      }

      $(elem).css({'transform': 'rotate(' + angle +'deg)'});

      var tPipeint = getPipeInterval();
      if(pipeint >= tPipeint) {
        pipeint = 0;
        addPipe();
      }

      elem.style.top = pos + "px";

      if(collide(elem, ground) || collide(elem, sky)) {
        clearInterval(id);
        dead();
      }

      $('.pipe').each(function(index, element) {
        var left = $(element).position().left;

        if(collide(elem, element)) {
          clearInterval(id);
          dead();
        }

        if(collide(element, leftborder)) {
            let tContainer = document.getElementById("container");
            tContainer.removeChild(element);
        } else {
          element.style.left = left - 2.5 + "px";
        }

        // if(left > -100) {
        //   element.style.left = left - 2.5 + "px";
        // } else {
        //   let tContainer = document.getElementById("container");
        //   tContainer.removeChild(element);
        // }
      });

      $('.gate').each(function(index, element) {
        var left = $(element).position().left;

        if(collide(elem, element)) {
          score++;
          $('#score').text(score);
          let tContainer = document.getElementById("container");
          tContainer.removeChild(element);
        }

        element.style.left = left - 2.5 + "px";
      });
    }
  }
}

function addPipe() {
  var pipeHeight = getPipeHeight();
  var pipeDistance = getPipeDistance();

  var topPipe = document.createElement("div");
  topPipe.classList.add("pipe");
  topPipe.style.top = "0px";
  topPipe.style.height = pipeHeight + "px";

  var bottomPipe = document.createElement("div");
  bottomPipe.classList.add("pipe");
  bottomPipe.style.top = pipeHeight + pipeDistance + "px";
  bottomPipe.style.height = 800 - pipeHeight - pipeDistance + "px";

  var gate = document.createElement("div");
  gate.classList.add("gate");

  $('#container').append(topPipe);
  $('#container').append(bottomPipe);
  $('#container').append(gate);
}

function getPipeHeight() {
  var max = 250;
  var min = 100;
  return Math.random() * (max - min) + min;
}

function getPipeDistance() {
  var max = 250;
  var min = 150;
  return Math.random() * (max - min) + min;
}

function getPipeInterval() {
  var max = 300;
  var min = 150;
  return Math.random() * (max - min) + min;
}

function collide(el1, el2) {
  var rect1 = el1.getBoundingClientRect();
  var rect2 = el2.getBoundingClientRect();

  return !(
    rect1.top > rect2.bottom - 15 ||
    rect1.right < rect2.left + 10  ||
    rect1.bottom < rect2.top + 15 ||
    rect1.left > rect2.right - 15
  );
}

$('#dead').hide();
function dead() {
  $('#menu').fadeIn();
  $('.dead').show();
  $('#dead-score').show();
}

$('#container').on('click', function() {
  flap();
});

function flap() {
  if(flapppower < 100) {
    flapppower += 20;
  }
  if(angle > 90) {
    angle -= 60;
  }

  pos -= flapppower;
  gravity = 0;
  velocity = 0;
}
</script>
{%footer%}
