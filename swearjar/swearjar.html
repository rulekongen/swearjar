{%head%}
<title>SWEAR JAR!</title>
{%menu%}
<div class="container-fluid pt-2">
  <div class="row">
    {%sidemenu%}
    <div class="card col-sm-12 col-md-8 col-lg-8 my-1">
      <div class="card-body" data-source="namesAndEntries">
        <span>
          <span class="h3">Scoreboard</span>
          <span style="float: right;" class="small">(<span onload="getUsername()" id="username" class="small">No name, no snitching</span> <a class="small" href="javascript:void(0)" onclick="setUsername()">Set name</a>)</span>
        </span>
        <table class="table" >
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Score in <span id="currentmonth"></span></th>
              <th scope="col">Total score</th>
              <th scope="col" colspan="90"></th>
            </tr>
          </thead>
          <tbody>
                <tr data-repeat data-active>
                  <td><span data-field="Name"></span></td>
                  <td><span data-field="ScoreThisMonth"></span></td>
                  <td><a href="javascript:void(0)" onclick="showLog()" data-field="Score"></a></td>
                  <td><button class="btn-secondary btn poeng" onclick="snitch()">Snitch</button></td>
                </tr>
          </tbody>
        </table>
    </div>
  </div>
</div>

<div id="swearlog-modal" class="modal fade pt-5" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Swear log</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul data-source="entries">
          <li data-repeat><strong>Date:</strong> <span class="datestring" data-field="Created"></span> <strong>Snitch:</strong><span data-field="Snitch"></span> <strong>Word:</strong> <span data-field="Word"></span></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  gAuthenticated = false;
  isAuthenticated(function(isAuthenticated) {
    gAuthenticated = isAuthenticated;
  });

  $(window).resize(function() {
    sidebar();
  });
  function sidebar() {
    if ($(window).innerWidth() > 767) {
      $("#sidemenu-items").show();
    } else {
       $("#sidemenu-items").hide();
    }
  }
  sidebar();

  var dsNamesAndEntries, dsEntries;

  $(document).ready(function() {
    $('#currentmonth').text(new XDate().toString("MMM"));

    dsNamesAndEntries = new dataSource({
      name: "namesAndEntries",
      dataFields: ["ID", "Name", "Score", "ScoreThisMonth"],
      view: "aviw_Swearjar_Scoreboard",
      orderBy: "Score DESC",
      anonymous: !gAuthenticated
    });

    dsEntries = new dataSource({
      name: "entries",
      dataFields: ["ID", "Snitch", "Word", "Created", "Name_ID", "Snitch_ID"],
      editFields: ["Snitch", "Word", "Name_ID", "Snitch_ID"],
      view: "aviw_Swearjar_Entries",
      targetTable: "atbl_Swearjar_Entries",
      orderBy: "Created DESC",
      anonymous: !gAuthenticated
    });

    dsNamesAndEntries.on("onSelectedRowChanged", function(pRow) {
      dsEntries.where = "Name_ID = " + pRow.ID;
      dsEntries.getData();
    });

    dsNamesAndEntries.getData();
  });

  function snitch() {
    if(!sessionStorage.firstname || sessionStorage.firstname === "undefined" || sessionStorage.firstname === "null") {
      alert("Could not determine name, please log in or set name to snitch");
      return;
    }

    vWord = prompt("What word was used?");
    if(vWord) {
      dsEntries.addNew();
      dsEntries.selectedRow("Snitch", sessionStorage.firstname);
      dsEntries.selectedRow("Snitch_ID", sessionStorage.user_id ? sessionStorage.user_id : null);
      dsEntries.selectedRow("Word", vWord);
      dsEntries.selectedRow("Name_ID", dsNamesAndEntries.selectedRow("ID"));
      dsEntries.save(function() {
        dsNamesAndEntries.getData();
      });
    } else {
      if(!vWord) alert("No word provided, will not be scored");
    }
  }

  setUsername();
  function setUsername() {
    if (!sessionStorage.firstname || sessionStorage.firstname === "undefined" || sessionStorage.firstname === "null") {
      sessionStorage.firstname = prompt("What is your name?");
    }
    if(sessionStorage.firstname && sessionStorage.firstname !== "undefined" && sessionStorage.firstname !== "null") {
      $('#username').text(sessionStorage.firstname);
    } else {
      $('#username').text("No name, no snitching");
    }
  }

  function addPoint(pName) {
    vWord = prompt("What word was used?");
    if(gUsername && vWord) {
      post({name: pName, username: gUsername, word: vWord}, "/addpoint");
    } else {
      if(!gUsername) alert("Could not determine username");
      if(!vWord) alert("No word provided, will not be scored");
    }
  }

  function showLog() {
     $('#swearlog-modal').modal('show');
  }

</script>
{%footer%}
